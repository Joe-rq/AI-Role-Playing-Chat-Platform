# 优化方案（AI 角色扮演对话平台）

> 目标：提升稳定性、可维护性与答辩展示效果，优先改动小但收益高的点。

---

## 一、最高优先级（稳定性与成本控制）

### 1. 多模型动态切换 🟡 单SDK已完成，多厂商未实现
- **问题**：单模型配置限制角色能力与成本控制。
- **已实现（单SDK方案）**：
  - ✅ `Character` 实体添加 `preferredModel`、`temperature`、`maxTokens` 字段
  - ✅ 后端按角色配置动态传入模型ID（由OpenAI SDK处理）
  - ✅ 前端展示13个模型选项（含6大厂商名称）
  - ✅ 温度滑块、最大token输入框
- **限制说明**：
  - ⚠️ **仅支持OpenAI SDK**，通过 `model` 参数切换OpenAI系列模型
  - ⚠️ 列表中的Claude、Gemini、Qwen等**仅为展示**，实际调用仍走OpenAI SDK
  - ❌ 多厂商真正接入需要：抽象 `LLMProvider` 接口 + 各厂商SDK适配
- **文件**：
  - `backend/src/characters/entities/character.entity.ts` - 模型字段
  - `backend/src/chat/chat.service.ts` - 模型配置 + 列表
  - `frontend/src/views/Home.vue` - 模型选择UI

---

## 二、体验打磨（答辩加分项）

### 2. Markdown 渲染增强（部分完成）
- **问题**：基础渲染缺少高亮与公式，流式输出易抖动。
- **方案**：
  - 代码高亮：`highlight.js` 或 `prismjs`。
  - 数学公式：`KaTeX`（可选）。
  - 流式防抖：对未闭合标记进行缓冲再渲染。

### 3. 移动端适配优化（未开始）
- **问题**：键盘弹起遮挡输入框。
- **方案**：
  - 监听 `visualViewport` 或 `resize` 动态调整输入区。
  - 发送成功增加轻微触感反馈（Haptic API）。

### 4. 会话管理入口优化（未开始）
- **问题**：
  - 当前会话列表在独立页面，与角色对话脱节
  - 用户需要先退出当前对话 → 回到首页 → 点击"历史会话" → 查找特定角色的会话
  - 操作路径过长，影响使用效率
- **方案**：
  - **方案A（推荐）**：在对话页header添加"历史会话"按钮
    - 点击展开侧边栏或抽屉，显示当前角色的所有会话
    - 支持快速切换会话（无需多次跳转页面）
    - 新建会话、删除、重命名等操作集成
  - **方案B**：保留独立会话列表页，增加角色筛选
    - 默认显示全部会话，顶部提供角色筛选下拉框
    - 点击筛选后只显示该角色的会话
- **交互优化**：
  - 会话项显示：最后消息预览、时间戳、消息数量
  - 支持按时间倒序排列
  - 长按或右键菜单：重命名、导出、删除
  - 当前激活会话高亮显示
- **技术要点**：
  - 前端：侧边栏组件 + 会话切换逻辑
  - 后端：增加"按角色ID查询会话列表"接口（已有）
  - 优化会话加载性能（缓存、懒加载）

---

## 三、安全与运维（风险控制）

### 5. API 鉴权与限流（未开始）
- **问题**：管理接口裸奔，LLM 成本易被刷爆。
- **方案**：
  - 后端增加 `X-Admin-Secret` 校验。
  - 接入 `@nestjs/throttler` 对请求限流。

### 6. 错误恢复机制（未开始）
- **问题**：SSE 中断后用户无恢复路径。
- **方案**：
  - 前端增加重试按钮或自动重连逻辑。
  - 后端可返回“可恢复”的错误码。

---

## 执行建议（最小收益最大化）

1. 多模型动态切换（多厂商接入）  
2. Markdown 渲染增强  
3. 移动端适配优化  
4. 会话管理入口优化  
5. API 鉴权与限流 + 错误恢复机制

---

## 里程碑建议

- **M4（未开始）**：多模型（多厂商接入）
