# 优化方案（AI 角色扮演对话平台）

> 目标：提升稳定性、可维护性与答辩展示效果，优先改动小但收益高的点。

---

## 一、最高优先级（稳定性与成本控制）

### 1. Token 消耗统计
- **问题**：缺乏对 LLM 成本的直观感知，无法评估 Prompt 效率。
- **方案**：记录每一轮对话的 Prompt Token 和 Completion Token。
- **落地**：
  - 非流式：从 API 响应的 `usage` 字段直接获取。
  - 流式：部分模型支持 `stream_options: { include_usage: true }`，若不支持则需后端进行字符数估算（1k tokens ≈ 750 汉字/单词）。
  - 展示：后端日志记录 `usage`，展示在开发控制台。

### 2. 图片处理优化
- **问题**：原图直接上传，体积大，Vision 成本高且易超时。
- **方案**：
  - 前端压缩：上传前缩放至 1024px 以内，转为 WebP。
  - 进度反馈：前端实现上传进度条，提升大图上传时的交互预期。
  - 后端二次处理：使用 `sharp` 统一尺寸与质量。
- **落地**：
  - 前端增加 Canvas 压缩（或 compressorjs）+ XHR/Axios `onUploadProgress` 监听。
  - 后端 upload 流程接入 `sharp`。

---

## 二、核心功能增强（展示效果与可扩展性）

### 3. 多模型动态切换
- **问题**：单模型配置限制角色能力与成本控制。
- **方案**：
  - `Character` 增加 `preferredModel` 与 `temperature` 字段。
  - 调用 LLM 时按角色配置选择模型与参数。
  - 供应商配置与 API Key 仅在后端维护，前端只展示可用模型列表。
- **落地**：
  - 迁移实体字段 + 管理界面补字段。
  - LLM 调用参数改为角色驱动。
  - 配置走 `.env`/`providers.json`，前端通过接口获取可用模型。

### 4. 人设系统增强
- **问题**：仅 systemPrompt，难保持“人设稳定”。
- **方案**：
  - Prompt 中支持变量占位符（如 `{{user_name}}`、`{{current_time}}`）。
  - 新增 `example_dialogues`（few-shot）。
- **落地**：
  - 角色实体扩展字段。
  - 拼接 prompt 时做变量注入 + few-shot 拼接。

---

## 三、体验打磨（答辩加分项）

### 5. 停止生成功能 (Stop Generation)
- **问题**：AI 回复过长或非预期时，用户无法打断，浪费 Token 且体验差。
- **方案**：
  - 前端：通过 `AbortController` 实现一键中断连接。
  - 后端：监听 SSE `close` 事件，主动终止 LLM 流请求，避免模型继续运行。
- **落地**：聊天输入框上方增加“停止”按钮。

### 6. Markdown 渲染增强
- **问题**：基础渲染缺少高亮与公式，流式输出易抖动。
- **方案**：
  - 代码高亮：`highlight.js` 或 `prismjs`。
  - 数学公式：`KaTeX`（可选）。
  - 流式防抖：对未闭合标记进行缓冲再渲染。

### 7. 移动端适配优化
- **问题**：键盘弹起遮挡输入框。
- **方案**：
  - 监听 `visualViewport` 或 `resize` 动态调整输入区。
  - 发送成功增加轻微触感反馈（Haptic API）。

### 8. 流式输出自动滚动策略
- **问题**：流式输出时页面持续拉长，用户上滑阅读历史会被强制拉回底部或出现抖动。
- **方案**：
  - 仅当用户处于底部时自动跟随滚动。
  - 用户上滑后停止自动滚动，出现“新消息”提示，点击后再跳到底部。
  - 使用节流/防抖降低频繁滚动导致的抖动。

---

## 四、安全与运维（风险控制）

### 9. 配置项强校验
- **问题**：未配置 API Key 或数据库地址时，运行中报错难排查。
- **方案**：启动时对 `.env` 必填项进行校验。
- **最低必填列表**：
  - `OPENAI_API_KEY` / `OPENAI_BASE_URL` / `OPENAI_MODEL`
  - `DATABASE_URL` (或 SQLite 文件路径)
- **落地**：使用 NestJS `ConfigModule` 的 `validationSchema`。

### 10. API 鉴权与限流
- **问题**：管理接口裸奔，LLM 成本易被刷爆。
- **方案**：
  - 后端增加 `X-Admin-Secret` 校验。
  - 接入 `@nestjs/throttler` 对请求限流。

### 11. 错误恢复机制
- **问题**：SSE 中断后用户无恢复路径。
- **方案**：
  - 前端增加重试按钮或自动重连逻辑。
  - 后端可返回“可恢复”的错误码。

### 12. 统一日志系统
- **问题**：大量 `console.log` 难以追踪 SSE 中断或 LLM 错误。
- **方案**：
  - 使用 NestJS `Logger` 服务替换 `console.log`。
  - 区分 `Log/Warn/Error` 级别，便于演示和排障。

---

## 五、考核对齐补强

### 13. 历史记录与会话列表
- **问题**：仅单会话视图，缺少“历史管理”展示。
- **方案**：
  - 会话列表 + 分页加载。
  - 支持删除与导出。

### 14. 会话清理的前后端一致性
- **问题**：前端清空仅重置本地状态，后端残留“僵尸会话”。
- **方案**：
  - 前端 `clearHistory` 必须调用后端删除接口。
  - 将“会话删除”视为前后端同步的原子操作。

---

## 执行建议（最小收益最大化）

1. Token 消耗统计 + 图片压缩 + Markdown 高亮 + 配置强校验 + 统一日志  
2. 历史列表 + 会话清理一致性 + 流式自动滚动 + 停止生成  
3. 多模型与人设增强（展示差异化）

---

## 里程碑建议

- **M2（1天）**：Token 消耗统计 + 图片压缩 + Markdown 高亮 + 配置强校验 + 统一日志
- **M3（1天）**：历史列表 + 会话清理一致性 + 流式自动滚动 + 停止生成
- **M4（可选）**：多模型 + 人设增强
